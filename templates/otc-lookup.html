<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Include Select2 CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />

    <!-- Include jQuery (required for Select2) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Include jQuery UI CSS for Datepicker -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

    <!-- Include jQuery UI JS for Datepicker -->
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

    <!-- Include Select2 JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

    <title>OTC Search</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #ffffff;
            margin: 0;
            padding: 0;
        }

        .header::before {
            content: '';
            position: absolute;
            bottom: 0;
            height: 2px;
            width: 80%; /* Adjust the width of the line here */
            background-color: #ddd; /* Line color */
            left: 10%;
        }


        .header::before {
            content: '';
            position: absolute;
            bottom: 0;
            height: 2px;
            width: 80%; /* Adjust the width of the line here */
            background-color: #ddd; /* Line color */
            left: 10%;
        }

        .logo-container {
            font-weight: bold;
            color: #ff6600;
            font-size: 24px;
            text-transform: uppercase;
            display: inline-block;
        }

        .logo-container span {
            padding: 0 8px;
            color: #000000;
            font-weight: bold;
            color: #ff6600;
            font-size: 24px;
            text-transform: uppercase;
            display: inline-block;
        }

        .logo-container span {
            padding: 0 8px;
            color: #000000;
        }

        .logo {
            max-width: 150px;     /* Adjust the width of the logo */
            height: auto;         /* Maintain the aspect ratio */
        }
        .container {
            max-width: 1200px;
            margin: 20px auto;
            background: #ffffff;
            background: #ffffff;
            padding: 20px;
            border-radius: 0;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            overflow: visible;
            border-radius: 0;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            overflow: visible;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px; /* Adds space between items */
            justify-content: space-between;
        }
        .form-group label {
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .form-group label:hover {
            cursor: pointer;
        }

        .form-group {
            flex: 1;
            min-width: 180px; 
            max-width: 220px; 
            min-width: 180px; 
            max-width: 220px; 
            border: 1px solid #6c757d;
            padding: 10px; 
            border-radius: 4px;
            margin-top: 10px; 
            text-align: center;
        }

        label {
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }

        select, input[type="text"], input[type="number"], input[type="datetime-local"] {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #6c757d;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
        }

        .button {
            padding: 10px 20px;
            background-color: #191c2b; 
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease; 
        }
        
        .button:hover {
            background-color: #ff6600 !important; 
            background-color: #ff6600 !important; 
        }
        .nested-table {
            cursor: pointer;
        }

        .table-responsive {
            width: 100%;
            overflow-x: auto;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            padding: 2px;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
            font-size: 16px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border: 1px solid #ddd;
            max-width: 300px;
            word-wrap: break-word;
        }

        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        table tr:hover {
            background-color: #ff6600;
        }
        
        table.has-data tr:hover {
            background-color: #ff6600;
        }
        
        table:not(.has-data) tr:hover {
            background-color: transparent !important;
        }    
        .copy-btn {
            background: transparent;
            border: none;
            color: inherit;
            font-size: 0.85em;
            cursor: pointer;
            text-decoration: underline;
            padding: 0;
        }
        
        .copy-btn:hover {
            color: #71A6FC; 
            text-decoration: none;
        }

        .ui-datepicker td span, 
        .ui-datepicker td a {
            display: block;
            padding: 0.2em;
            text-align: center;
            text-decoration: none;
        }
        
        .ui-datepicker tr:hover {
            background-color: transparent !important;
        }
        
        .ui-datepicker td a:hover {
            background: #ff6600 !important;
            background: #ff6600 !important;
            color: white !important;
        }
        
        .ui-datepicker td a.ui-state-active {
            background: #6c757d;
            color: white;
            border: 1px solid #ff6600;
        }
        
        .ui-datepicker td a.ui-state-highlight {
            border: 1px solid #ff6600;
        }
        
        .ui-datepicker {
            z-index: 1000 !important;
        }

        #dynamicFields {
            display: flex;
            flex-direction: column;
            gap: 15px;  
            gap: 15px;  
            width: 100%;
            overflow: hidden;
            padding: 0px;
            padding: 0px;
            box-sizing: border-box;
            margin-top: 15px; 
        }

        /* Also adjust the horizontal row gap */

        /* Also adjust the horizontal row gap */
        .horizontal-row {
            display: flex;
            flex-direction: row;
            gap: 15px;  
            flex-wrap: wrap;
            padding: 0;
        }
        .dynamic-fields-row {
            display: flex;
            flex-direction: column; 
            gap: 15px; 
            flex-wrap: wrap;
            padding: 0;
        }



        #dynamicFields .form-group {
            min-width: 170px;
            max-width: 220px;
            max-width: 220px;
            box-sizing: border-box;
        }
        
        #dynamicFields select, #dynamicFields input, #dynamicFields textarea {
            width: 100%; 
            padding: 10px; 
            border: 1px solid #6c757d;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }
        #dynamicFields label {
            width: 100%; 
            padding: 10px; 
            border: none;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }
        
        #dynamicFields textarea {
            resize: vertical; 
            min-height: 38px;
        }
        
        @media (max-width: 600px) {
            #dynamicFields .form-group {
                min-width: 100%; 
            }
        }
        @media (max-width: 600px) {
            th, td {
                font-size: 14px;
            }
        }

        .searchable-select {
            position: relative;
            margin-top: 10px;
            max-width: 200px;
        }

        .searchable-select input {
            padding: 8px;
            width: 100%;
            box-sizing: border-box;
        }

        .dropdown-options {
            position: absolute;
            z-index: 10;
            background: white;
            border: 1px solid #ccc;
            width: 100%;
            max-height: 150px;
            overflow-y: auto;
            display: none;
        }

        .dropdown-options div {
            padding: 8px;
            cursor: pointer;
        }

        .dropdown-options div:hover {
            background-color: #6c757d;
        }

        /* Navbar */
        .navbar {
            display: flex;
            justify-content: center;
            background-color: #ffffff;
            padding: 10px;
        }

        .navbar-content {
            width: 1200px;  /* Match the container max-width */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .title {
            font-size: 1.2rem;
            font-weight: normal;
            color: #000000;
        }

        .title span {
            color: #ff6600;
        }

        .right-section {
            display: flex;
            align-items: center;
        }

        .logo {
            max-width: 150px;
            height: auto;
        }

        .bottom-line {
            height: 2px;
            background-color: #ddd;
        }

        /* Select2 Customization */
        .select2-container--default .select2-results__option--highlighted[aria-selected] {
            background-color: #ff6600 !important; /* Changes the blue highlight to orange */
            color: white;
        }

        /* Optional: Style the clear button (×) */
        .select2-container--default .select2-selection--single .select2-selection__clear:hover {
            color: #ff6600; /* Your orange color */
        }

        .navbar {
            display: flex;
            justify-content: center;
            background-color: #ffffff;
            padding: 10px;
        }
        
        .navbar-content {
            width: 1200px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .title {
            font-size: 1.2rem;
            font-weight: normal;
            color: #000000;
        }
        
        .title span {
            color: #ff6600;
        }
        
        .right-section {
            display: flex;
            align-items: center;
        }
        
        .logo {
            max-width: 150px;
            height: auto;
            cursor: pointer;
        }
        
        .bottom-line {
            height: 2px;
            background-color: #ddd;
        }

        /* Select2 Customization */
        .select2-container--default .select2-results__option--highlighted[aria-selected] {
            background-color: #ff6600 !important; /* Changes the blue highlight to orange */
            color: white;
        }

        /* Optional: Style the clear button (×) */
        .select2-container--default .select2-selection--single .select2-selection__clear:hover {
            color: #ff6600; /* Your orange color */
        }

        /* Add these CSS rules */
        #resultSection {
            margin-top: 40px;
        }

        .table-responsive {
            width: 100%;
            overflow-x: auto;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            padding: 2px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
<div class="navbar">
    <div class="navbar-content">
        <div class="title">
            REGTECH | DATAHUB <span>DEMO-SITE</span>
        </div>
        <div class="right-section">
            <a href="http://www.regtechdatahub.com" target="_blank">
                <img src="{{ url_for('static', filename='Logo.png') }}" alt="Logo" class="logo">
            </a>
        </div>
    </div>
</div>

<!-- Bottom Line -->
<div class="bottom-line"></div>


    <div class="container" style="padding: 20px; background-color: #191c2b; text-align: center;">
        <img 
            src="static/OTC-lookup.png"
            sizes="(max-width: 1024px) 100vw, 1024px"
            fetchpriority="high"
            decoding="async"
        >
    </div>
    <div class="container">
        <form id="searchForm">
            <div class="form-row">
                <div class="form-group">
                    <label for="assetClass">Asset Class</label>
                    <select id="assetClass" name="assetClass" onchange="updateInstrumentType(this.value)">
                        <option value="">Choose an Asset Class</option>
                        {% for option in all_data.assetClass %}
                            <option value="{{ option }}">{{ option }}</option>
                        {% endfor %}
                    </select>
                </div>
    
                <div class="form-group">
                    <label for="instrumentType">Instrument Type</label>
                    <select id="instrumentType" name="instrumentType" disabled onchange="updateUseCase(this.value)">
                        <option value="">Choose an Instrument Type</option>
                    </select>
                </div>
    
                <div class="form-group">
                    <label for="useCase">Use Case</label>
                    <select id="useCase" name="useCase" disabled onchange="updateLevel(this.value); setDefaultLevel(); performSearch();">
                        <option value="">Choose a Use Case</option>
                    </select>
                </div>
    
                <div class="form-group">
                    <label for="level">Level</label>
                    <select id="level" name="level" disabled onchange="updateTemplateVersion(this.value); performSearch();">
                        <option value="">Choose a Level</option>
                    </select>
                </div>
    
                <div class="form-group">
                    <label for="templateVersion">Template Version</label>
                    <select id="templateVersion" name="templateVersion" disabled onchange="performSearch()">
                        <option value="">Could be left blank</option>
                    </select>
                </div>
            </div>
        </form>

        <div id="dynamicFields"></div>
        <div id="button-container" style="display: flex; gap: 10px; margin-top: 20px; margin-bottom: 30px;">
            <button type="button" class="button" id="find-button" onclick="performFind()" style="display: none;">
                Find
            </button>
            <button type="button" class="button" id="clear-results-button" onclick="clearResults()" style="display: none;">
                Clear Results
            </button>
        </div>

        <div id="resultSection">
            <!-- Results will be displayed here -->
            <div id="results"></div>
        </div>
    </div>
    <script>
        const allData = {{ all_data | tojson | safe }};
        console.log('All Data:', allData);

        // Initialize select2 dropdowns
        $(document).ready(function() {
            $('.select2').select2();

            function matchCustom(params, data) {
                // If the user did not write any term in the freetext box, return all of the dropdown options
                if ($.trim(params.term) === '') {
                    return data;
                }
    
                // `params.term` is the user's search term
                // `data.text` is the option text
    
                // Check if the search term is anywhere in the option text
                if (data.text.toUpperCase().indexOf(params.term.toUpperCase()) > -1) {
                    return data;
                }
    
                // Return `null` if the term doesn't match
                return null;
            }
        // Initialize Select2 with the custom matcher and auto-focus on search field
        function focusSearchField() {
            let searchField = $('.select2-container--open .select2-search__field');
            if (searchField.length > 0) {
                searchField[0].focus();
            }
        }
        
        // Attach focus event for accessibility
        $('#assetClass').select2({ matcher: matchCustom, width: '100%' }).on('select2:open', focusSearchField);
        $('#instrumentType').select2({ matcher: matchCustom, width: '100%' }).on('select2:open', focusSearchField);
        $('#useCase').select2({ matcher: matchCustom, width: '100%' }).on('select2:open', focusSearchField);
        $('#level').select2({ matcher: matchCustom, width: '100%' }).on('select2:open', focusSearchField);
        $('#templateVersion').select2({ matcher: matchCustom, width: '100%' }).on('select2:open', focusSearchField);
            });
        function updateInstrumentType(assetClass) {
            let instrumentTypeDropDown = document.querySelector("#instrumentType");
            let previousInstrumentType = $('#instrumentType').val();
            let previousUseCase = $('#useCase').val();
            let previousLevel = $('#level').val();
            let previousTemplateVersion = $('#templateVersion').val();

            resetDropdown('instrumentType', false);  
            
            if (assetClass && allData.instrumentType[assetClass]) {
                // Populate the instrument type dropdown
                allData.instrumentType[assetClass].forEach(type => {
                    instrumentTypeDropDown.innerHTML += `<option value="${type}">${type}</option>`;
                });
                $('#instrumentType').prop('disabled', false).select2();

                // Restore previous instrument type if it matches the new options
                if (previousInstrumentType && allData.instrumentType[assetClass].includes(previousInstrumentType)) {
                    $('#instrumentType').val(previousInstrumentType).trigger('change');

                    // Attempt to restore the use case
                    if (previousUseCase) {
                        updateUseCase(previousInstrumentType, previousUseCase, previousLevel, previousTemplateVersion);
                    }
                } else {
                    // If instrument type changes, reset the dependent dropdowns
                    resetDropdown('useCase', true);
                    resetDropdown('level', true);
                    resetDropdown('templateVersion', true);
                }
            }
        }

        function updateUseCase(instrumentType, previousUseCase = null, previousLevel = null, previousTemplateVersion = null) {
            let useCaseDropDown = document.querySelector("#useCase");
            let assetClass = document.querySelector("#assetClass").value;
            
            resetDropdown('useCase', false);

            // Get the use case options from allData
            if (assetClass && instrumentType && 
                allData.useCase[assetClass] && 
                allData.useCase[assetClass][instrumentType]) {
                
                const currentOptions = allData.useCase[assetClass][instrumentType];

                if (currentOptions.length > 0) {
                    // Populate the use case dropdown
                    currentOptions.forEach(use => {
                        useCaseDropDown.innerHTML += `<option value="${use}">${use}</option>`;
                    });

                    $('#useCase').prop('disabled', false).select2();

                    // Restore previous selection if it matches the new options
                    if (previousUseCase && currentOptions.includes(previousUseCase)) {
                        $('#useCase').val(previousUseCase).trigger('change');

                        // Attempt to restore level and template version
                        if (previousLevel) {
                            updateLevel(previousUseCase, previousLevel, previousTemplateVersion);
                        }
                    }
                }
            }
        }

        // Add this mapping object
        const levelDisplayMap = {
            'InstRefDataReporting': 'ISIN',
            // Add other mappings if needed
        };

        // Modify the updateLevel function to use the display mapping
        function updateLevel(useCase, previousLevel = null, previousTemplateVersion = null) {
            let levelDropDown = document.querySelector("#level");
            let assetClass = document.querySelector("#assetClass").value;
            let instrumentType = document.querySelector("#instrumentType").value;
            
            resetDropdown('level', false);

            if (assetClass && instrumentType && useCase && 
                allData.level[assetClass] &&
                allData.level[assetClass][instrumentType] && 
                allData.level[assetClass][instrumentType][useCase]) {
                
                allData.level[assetClass][instrumentType][useCase].forEach(level => {
                    // Use the display mapping for the visible text, but keep the original value
                    const displayText = levelDisplayMap[level] || level;
                    levelDropDown.innerHTML += `<option value="${level}">${displayText}</option>`;
                });
                $('#level').prop('disabled', false).select2();
                
                // Restore previous selection if it exists in new options
                if (previousLevel && allData.level[assetClass][instrumentType][useCase].includes(previousLevel)) {
                    $('#level').val(previousLevel).trigger('change');
                    
                    if (previousTemplateVersion) {
                        updateTemplateVersion(previousLevel, previousTemplateVersion);
                    }
                } else {
                    setDefaultLevel();
                }
            }
        }

        function updateTemplateVersion(level, previousTemplateVersion = null) {
            let templateVersionDropDown = document.querySelector("#templateVersion");
            let assetClass = document.querySelector("#assetClass").value;
            let instrumentType = document.querySelector("#instrumentType").value;
            let useCase = document.querySelector("#useCase").value;
            
            resetDropdown('templateVersion', false);

            if (assetClass && instrumentType && useCase && level &&
                allData.templateVersion[assetClass] &&
                allData.templateVersion[assetClass][instrumentType] &&
                allData.templateVersion[assetClass][instrumentType][useCase] &&
                allData.templateVersion[assetClass][instrumentType][useCase][level]) {

                allData.templateVersion[assetClass][instrumentType][useCase][level].forEach(version => {
                    templateVersionDropDown.innerHTML += `<option value="${version}">${version}</option>`;
                });
                $('#templateVersion').prop('disabled', false).select2();
                
                // Restore previous selection if it exists in new options
                if (previousTemplateVersion && 
                    allData.templateVersion[assetClass][instrumentType][useCase][level].includes(previousTemplateVersion)) {
                    $('#templateVersion').val(previousTemplateVersion).trigger('change');
                }
            }
        }

        function resetDropdown(dropdownId, disable = true) {
            let dropdown = document.querySelector(`#${dropdownId}`);
            if (dropdownId === 'templateVersion') {
                dropdown.innerHTML = `<option value="">Could be left blank</option>`;
            } else {
                dropdown.innerHTML = `<option value="">Choose a ${dropdownId.charAt(0).toUpperCase() + dropdownId.slice(1)}</option>`;
            }
            if (disable) {
                $(`#${dropdownId}`).prop('disabled', true).select2();
            }
        }

        // Function to perform the search and get dynamic fields
        function performSearch() {
            const assetClass = $('#assetClass').val(); // Get selected asset class
            const instrumentType = $('#instrumentType').val(); // Get selected instrument type

            const formData = {
                assetClass: assetClass,
                instrumentType: instrumentType,
                useCase: $('#useCase').val(),
                level: $('#level').val(),
                templateVersion: $('#templateVersion').val()
            };

            console.log('Selected Asset Class:', assetClass);
            console.log('Selected Instrument Type:', instrumentType);

            fetch('/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                generateDynamicFields(data);
                
            })
            .catch(error => {
                console.error('Error fetching attributes:', error);
            });
        }

        function clearResults() {
            // Clear displayed results
            $('#results').empty();
            // Keep both the Find and Clear Results buttons visible
            $('#find-button').css('display', 'block');
            $('#clear-results-button').css('display', 'block');
        }

        function performFind() {
            const formData = {
                header: {
                    assetClass: $('#assetClass').val(),
                    instrumentType: $('#instrumentType').val(),
                    useCase: $('#useCase').val(),
                    level: $('#level').val(),
                    templateVersion: $('#templateVersion').val()
                },

                instrumentLimit: 0,  
                templateSearchDirection: "HighestToLowest",  
                extractAttributes: true, 
                extractDerived: true,  
                expiryDatesSpans: 0,  
                deriveCfiCodeProperties: true,  
                attributes: gatherDynamicFields()  
            };
            console.log('Static Field Values:', {
            assetClass: $('#assetClass').val(),
            instrumentType: $('#instrumentType').val(),
            useCase: $('#useCase').val(),
            level: $('#level').val(),
            templateVersion: $('#templateVersion').val()
        });
            console.log("Form Data being sent to the API:");
            console.log("Form Data being sent:", formData);  // DEBUG: Log the form data being sent

            fetch('/find', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                console.log("Response from server:", data);
                // Use the correlation_id from the response data
                displayResults(data, data.correlation_id);
            })
            .catch(error => {
                console.error('Error fetching instruments:', error);
            });
        }

         function gatherDynamicFields() {
            const dynamicFields = {};
            // Loop through all dynamically generated form fields
            $('#dynamicFields .form-group').each(function() {
                const label = $(this).find('label').text();
                const input = $(this).find('input, textarea, select');
                let value;
        
                // Get the value based on input type
                if (input.hasClass('select2')) {
                    value = input.val(); // Get Select2 value
                } else {
                    value = input.val();  // Get other input values
                }
                
                // Only add dynamicFields if the value exists and is not empty
                if (!value || value.trim() === '' || value === null) {
                    return true; // This is equivalent to 'continue' in jQuery's .each()
                }
        
                dynamicFields[label] = value; // Only add if value passes validation
            });
            
            console.log("Dynamic Fields Collected:", dynamicFields);  // DEBUG: Log the collected dynamic fields
            return dynamicFields;
        }
        
        // Function to copy row content to the clipboard
        function copyRowContentToClipboard(rowElement) {
            const text = $(rowElement).find('td:last').text().trim(); // Get the text of the last <td> in the row
        
            // If the text is not empty, proceed with copying to clipboard
            if (text && text !== "N/A") { // You can also customize the condition based on how you handle "no data"
                navigator.clipboard.writeText(text).then(() => {
                    alert('Row content copied to clipboard!');
                }).catch(err => {
                    console.error('Failed to copy text: ', err);
                });
            } else {
                alert('No content to copy!');
            }
        }

        
        // Function to display results from the API in a table
        function displayResults(data, correlationId) {
            console.log("Data received in displayResults:", data);
            const resultsDiv = $('#results');
        
            if (data.instruments) {
                let table = '<div class="table-responsive"><table style="table-layout: fixed;">';
                table += '<tr>';
                table += '<th style="width: 34%;">Identifier</th>';
                table += '<th style="width: 32.5%;">Attributes</th>';
                table += '<th style="width: 33.5%;">Derived</th>';
                table += '</tr>';
        
                Object.keys(data.instruments).forEach(isin => {
                    const instrument = data.instruments[isin];
                    console.log("Processing instrument:", instrument);
        
                    const isinId = instrument.identifier;
                    const parentIdentifier = instrument.parentIdentifier;
                    const status = instrument.annaDsbStatus;
                    const classification = instrument.classificationType;
                    const lastUpdated = new Date(instrument.lastUpdateDateTime).toISOString().split('T')[0];
        
                    // Get template information from form
                    const assetClass = $('#assetClass').val();
                    const instrumentType = $('#instrumentType').val();
                    const useCase = $('#useCase').val();
                    const level = $('#level').val();
                    const templateVersion = $('#templateVersion').val() || '*';
        
                    // Create template string with dots as separators
                    // Use the display mapping for level in the visible template string
                    const displayLevel = levelDisplayMap[level] || level;
                    const templateInfo = `${assetClass}.${instrumentType}.${useCase}.${displayLevel}.${templateVersion}`;
        
                    // Modified nested table for Identifier column to include Template info
                    const identifierTable = `
                        <table class="nested-table" style="font-size: 0.85em; width: 100%; table-layout: fixed;">
                            <tr onclick="copyRowContentToClipboard(this)">
                                <td style="text-align: left; width: 30%; overflow: hidden; text-overflow: ellipsis;">ID:</td>
                                <td style="text-align: right; width: 70%; overflow: hidden; text-overflow: ellipsis;">${isinId}</td>
                            </tr>
                            <tr onclick="copyRowContentToClipboard(this)">
                                <td style="text-align: left; width: 30%; overflow: hidden; text-overflow: ellipsis;">Parent:</td>
                                <td style="text-align: right; width: 70%; overflow: hidden; text-overflow: ellipsis;">${parentIdentifier || 'N/A'}</td>
                            </tr>
                            <tr onclick="copyRowContentToClipboard(this)">
                                <td style="text-align: left; width: 30%; overflow: hidden; text-overflow: ellipsis;">Status:</td>
                                <td style="text-align: right; width: 70%; overflow: hidden; text-overflow: ellipsis;">${status}</td>
                            </tr>
                            <tr onclick="copyRowContentToClipboard(this)">
                                <td style="text-align: left; width: 30%; overflow: hidden; text-overflow: ellipsis;">Classification:</td>
                                <td style="text-align: right; width: 70%; overflow: hidden; text-overflow: ellipsis;">${classification}</td>
                            </tr>
                            <tr onclick="copyRowContentToClipboard(this)">
                                <td style="text-align: left; width: 30%; overflow: hidden; text-overflow: ellipsis;">Last Updated:</td>
                                <td style="text-align: right; width: 70%; overflow: hidden; text-overflow: ellipsis;">${lastUpdated}</td>
                            </tr>
                            <tr onclick="copyRowContentToClipboard(this)">
                                <td style="text-align: left; width: 30%; overflow: hidden; text-overflow: ellipsis;">Template:</td>
                                <td style="text-align: right; width: 70%; overflow: hidden; text-overflow: ellipsis;">${templateInfo}</td>
                            </tr>
                            <tr onclick="copyRowContentToClipboard(this)">
                                <td style="text-align: left; width: 30%; overflow: hidden; text-overflow: ellipsis;">Correlation:</td>
                                <td style="text-align: right; width: 70%; overflow: hidden; text-overflow: ellipsis;">${correlationId}</td>
                            </tr>
                        </table>`;
        
                    // Row for each instrument
                    table += `<tr style="background-color: transparent;">
                                <td>${identifierTable}</td>
                                <td>${createAttributesTable(instrument.attributes)}</td>
                                <td style="font-size: 0.95em;">${createDerivedTable(instrument.derived)}</td>
                              </tr>`;
                });
        
                table += '</table></div>';
                resultsDiv.prepend(table);
                
                updateTableHoverEffect();
            } else {
                resultsDiv.prepend('<p>No instruments found.</p>');
            }

            setTimeout(() => {
                $('.new-search-row').css('background-color', '');
            }, 3000);
        }

        // Helper functions to create the nested tables for attributes and derived data
        function createAttributesTable(attributes) {
            if (!attributes) return 'N/A';
            return `<table class="nested-table" style="font-size: 0.80em; width: 100%; table-layout: fixed;">
                ${Object.entries(attributes)
                    .map(([key, value]) =>
                        `<tr onclick="copyRowContentToClipboard(this)">
                            <td style="text-align: left; width: 40%; overflow: hidden; text-overflow: ellipsis;">${key}</td>
                            <td style="text-align: right; width: 60%; overflow: hidden; text-overflow: ellipsis; word-break: break-word;">${value}</td>
                         </tr>`
                    ).join('')}
               </table>`;
        }

        function createDerivedTable(derived) {
            if (!derived) return 'N/A';
            return `<table class="nested-table" style="font-size: 0.76em; width: 100%; table-layout: fixed;">
                ${Object.entries(derived)
                    .map(([key, value]) =>
                        `<tr onclick="copyRowContentToClipboard(this)">
                            <td style="text-align: left; width: 40%; overflow: hidden; text-overflow: ellipsis;">${key}</td>
                            <td style="text-align: right; width: 60%; overflow: hidden; text-overflow: ellipsis; word-break: break-word;">${value}</td>
                         </tr>`
                    ).join('')}
               </table>`;
        }

        // Function to copy the correlation ID to the clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Correlation ID copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy text: ', err);
            });
        }
        // Function to check if a table has data and add/remove 'has-data' class accordingly
        function updateTableHoverEffect() {
            $('table').each(function() {
                // Check if table has any rows with data
                if ($(this).find('tr').length > 0) { // Assuming the first row is the header
                    $(this).addClass('has-data');
                } else {
                    $(this).removeClass('has-data');
                }
            });
        }


       // Call this function when you want to initialize the Select2 elements for dynamically created fields
       function initDynamicSelect2() {
           function focusSearchField() {
               let searchField = $('.select2-container--open .select2-search__field');
               if (searchField.length > 0) {
                   searchField[0].focus();
               }
           }
       
           $('#dynamicFields .select2').select2({
               placeholder: 'Search',
               allowClear: true
           }).on('select2:open', focusSearchField);
            }

        
        function createFieldElement(attributeKey, attribute) {
            const fieldDiv = $('<div>').addClass('form-group').css('margin-top', '10px'); 
            const tooltipText = `${attributeKey}: ${attribute.description || 'No description available'}`;
            const label = $('<label>').text(attributeKey).attr('title', tooltipText);
            fieldDiv.append(label);

            console.log(`    Processing field: ${attributeKey} - DataType: ${attribute.dataType}`);
            handledAttributes.push(attributeKey);
            console.log(`    Handled attribute: ${attributeKey}`);

            if (attribute.dataType === 'InstrumentTypeEnum') {
                console.log(`Skipping 'InstrumentTypeEnum' field for: ${attributeKey}`);
                return null; 
            }

            let input;
            if (attribute.enumSpan) {
                console.log(`    Created searchable dropdown for enumSpan: ${attributeKey}`);
                createSearchableDropdown(fieldDiv, attributeKey, attribute.enumSpan);
            } else if (attribute.dataType === 'string') {
                console.log(`    Created text input for: ${attributeKey}`);
                input = $('<input>').attr('type', 'text').attr('placeholder', `Enter ${attributeKey}`).attr('name', attributeKey).css('padding', '5px');
            } else if (attribute.dataType === 'int' || attribute.dataType === 'integer') {
                console.log(`    Created integer input for: ${attributeKey}`);
                input = $('<input>').attr('type', 'number').attr('min', '1').val('1').attr('name', attributeKey).css('padding', '5px');
            } else if (attribute.dataType === 'number') {
                console.log(`    Created number input for: ${attributeKey}`);
                input = $('<input>').attr('type', 'number').attr('step', '0.1').attr('min', '0').val('1.0').attr('name', attributeKey).css('padding', '5px');
            } else if (attribute.dataType === 'datetime' || attribute.dataType === 'DateTime') {
                input = $('<input>').attr('type', 'text')
                    .attr('placeholder', 'YYYY-MM-DD')
                    .css('width', '100%')
                    .attr('name', attributeKey)
                    .css('padding', '5px');
                console.log(`    Created datetime input for: ${attributeKey}`);
                
                input.datepicker({
                    dateFormat: "yy-mm-dd",
                    changeMonth: true,
                    changeYear: true,
                    showButtonPanel: true,
                    firstDay: 1,
                    yearRange: "-100:+10",
                    beforeShow: function(input) {
                        setTimeout(function() {
                            $(".ui-datepicker").css("z-index", 1000);
                        }, 0);
                    },
                    onSelect: function(dateText) {
                        $(this).datepicker("hide");
                    }
                });

                input.on('keypress', function(event) {
                    if (event.which === 13) {
                        event.preventDefault();
                        const dateValue = $(this).val().trim();
                        const datePattern = /^\d{4}-\d{2}-\d{2}$/;
                        if (datePattern.test(dateValue)) {
                            const parsedDate = $.datepicker.parseDate("yy-mm-dd", dateValue);
                            if (parsedDate) {
                                $(this).datepicker("setDate", parsedDate);
                                $(this).datepicker("hide");
                                $(this).blur();
                            } else {
                                alert('Invalid date. Please enter a valid date in the format YYYY-MM-DD.');
                            }
                        } else {
                            alert('Please enter a valid date in the format YYYY-MM-DD.');
                        }
                    }
                });
            } else if (attribute.dataType === 'array') {
                input = $('<textarea>').attr('placeholder', `Enter ${attributeKey} as comma-separated values`).attr('name', attributeKey).css('padding', '5px');
            }

            if (input) {
                fieldDiv.append(input);
            }
            return fieldDiv;
        }

        
        const handledAttributes = [];

        
        function generateDynamicFields(data) {
            const dynamicFieldsDiv = $('#dynamicFields');
            dynamicFieldsDiv.empty(); 


            const selectedAssetClass = $('#assetClass').val(); 
            const selectedInstrumentType = $('#instrumentType').val(); 


            const fieldHierarchy = data.field_hierarchy[0];
            console.log("Field hierarchy: ", fieldHierarchy);

            const fieldsToAdd = [];

            // create horizontal div
            var currentDivRow = -1; 
            var currenthorizontalDiv = null;

            $.each(fieldHierarchy, function (assetClass, assetData) {
                    if (assetClass !== selectedAssetClass) return; 
                    //console.log(`Processing asset class: ${assetClass}`);
                    //console.log(`Processing asset Data: ${JSON.stringify(assetData)}`);

                    
                    $.each(assetData, function (instrumentType, fields) {
                        if (instrumentType !== selectedInstrumentType) return; 
                        //console.log(`fields are: ${JSON.stringify(fields)}`);

                        
                        if (fields) {
                            //console.log("Processing field: " + fields.name);
                        
                        } else {
                            console.log("Field or dataType is undefined for: " + instrumentType);
                            return;
                        }
                        
                        if (Array.isArray(fields)) {
                            console.log(`  It is an array and Processing instrument type: ${instrumentType}`);

                            console.log(` fieldsobject ${JSON.stringify(fields)}`);
                            // sort by row , column , name 
                            orderedFields = fields.sort((a, b) => {
                                // First, sort by row
                                if (a.row !== b.row) {
                                    return a.row - b.row;
                                }
                                // If rows are the same, then sort by column
                                if (a.column !== b.column) {
                                    return a.column - b.column;
                                }
                                // If both row and column are the same, then sort by name
                                return a.name.localeCompare(b.name);
                            });
                            console.log(` ordered fields ${JSON.stringify(orderedFields)}`);

                            $.each(fields, function (index, field) {
                                console.log(`field is: ${JSON.stringify(field)}`);
                                const attributeKey = field.name;
                                const attribute = data.attributes[attributeKey];
                                console.log(`fields is an array. index: ${index}, field: `, field);
                                if (!attribute) {
                                    console.log(`Attribute data missing for key ${attributeKey}`);
                                    return
                                }
                                if (currentDivRow !== field.row || !currenthorizontalDiv) {
                                    if (currenthorizontalDiv) {
                                        console.log(`Adding horizontal div with divRow = ${currentDivRow}`);
                                        dynamicFieldsDiv.append(currenthorizontalDiv);
                                    }
                                    console.log(`new row detected : ${currentDivRow}, versus ${field.row}`);

                                    //if (currentDivRow > 0) { //check currentHorizont div element has subelements
                                    //    console.log(`add Horizontal DivElement = ${currentDivRow} to verticalDivElement`);
                                    //    console.log(`create new horizontal div with divRow = ${field.row}`);
                                    //}
                                    currentDivRow = field.row;
                                    currenthorizontalDiv = $(`<div class="horizontal-row" data-row="${currentDivRow}"></div>`);
                                    console.log(`Create new horizontal div with divRow = ${currentDivRow}`);
                                }
                                if (!field.name) {
                                    console.log(`Field does not have a name at index ${index}`);
                                } else {
                                    console.log(`Processing field: ${field.name}`);
                                }

                                //console.log(`fields is an array. index: ${index}, field: `, field);
                                //console.log(`data.attributes is: ${JSON.stringify(data.attributes[attributeKey])}`);



                                if (attribute && dynamicFieldsDiv.find(`[name="${attributeKey}"]`).length === 0) { 
                                    let isHandled = false;
                                    const { name, row, column } = field;
                                    //console.log(`Processing field: ${name} - Row: ${row}, Column: ${column}`);

                                    // Create field element and add it to the fieldsToAdd array with its row priority
                                    //if (currentDivRow == )
                                    const fieldElement = createFieldElement(attributeKey, attribute);
                                    console.log(`append field ${field.name} to currenthorizontalDiv = ${currentDivRow}`);
                                    //append dynamic field you create to the horizontal div( + append splitter . fixed size)
                                    if (fieldElement) {
                                        currenthorizontalDiv.append(fieldElement);
                                    }
                                


                                }

                            });
                            if (currenthorizontalDiv) {
                                dynamicFieldsDiv.append(currenthorizontalDiv);
                                initDynamicSelect2();

                                initDynamicSelect2();

                            } 
                            // check if the horizontal div contains subelements
                            console.log(`add Horizontal DivElement = ${currentDivRow} to verticalDivElement`);

                        }

                    }); 
                });



            }; 

            initDynamicSelect2();
            
            $('#find-button').css('display', 'block');
            $('#clear-results-button').css('display', 'block');


            
            const notHandledAttributes = Object.keys(data.attributes).filter(key => !dynamicFieldsDiv.find(`[name="${key}"]`).length);
            notHandledAttributes.forEach(attributeKey => {
                const attribute = data.attributes[attributeKey];
                if (!isHandled) { 
                    const fieldDiv = createFieldElement(attributeKey, attribute);
                    if (fieldDiv) {
                        dynamicFieldsDiv.append(fieldDiv);
                    }
                }
            });



        console.log("Handled Attributes: ", handledAttributes);
        console.log("Not Handled Attributes: ", notHandledAttributes);


        
        function createSearchableDropdown(container, attributeKey, options) {
            const select = $('<select>').addClass('select2')
                                        .attr('name', attributeKey)
                                        .attr('placeholder', `Search ${attributeKey}`);
            select.append(new Option(`Search ${attributeKey}`, '', true, true));

            options.sort().forEach(option => {
                select.append(new Option(option, option));
            });

            container.append(select);

                
            // Initialize Select2 and focus the search field after it has been opened
                
            // Initialize Select2 and focus the search field after it has been opened
            select.select2({
                placeholder: `Search ${attributeKey}`,
                allowClear: true
            }).on('select2:open', function () {
                setTimeout(function () {
                    // Focus the search field inside the dropdown after it opens
                    let searchField = $('.select2-container--open .select2-search__field');
                    if (searchField.length > 0) {
                        searchField[0].focus();
                    }
                }, 100); // Delay to ensure the dropdown is fully opened before focusing
            }).on('select2:open', function () {
                setTimeout(function () {
                    // Focus the search field inside the dropdown after it opens
                    let searchField = $('.select2-container--open .select2-search__field');
                    if (searchField.length > 0) {
                        searchField[0].focus();
                    }
                }, 100); // Delay to ensure the dropdown is fully opened before focusing
            });
        }

        function setDefaultLevel() {
            // Set Level to "InstRefDataReporting"
            $('#level').val('InstRefDataReporting').trigger('change');
            
            // If using Select2, update the Select2 display
            $('#level').trigger('select2:update');
        }

    </script>
    <footer class="border-top footer text-muted">
        <div class="container"> © 2020 - Capital Market Partners A/S </div>
    </footer>
</body>
</html>

